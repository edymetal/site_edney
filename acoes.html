<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise de Ações</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f8f9fa; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 250px; background-color: #2c3e50; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; flex-shrink: 0; height: 100vh; }
        #sidebar h2 { color: #ffffff; margin-top: 0; margin-bottom: 20px; text-align: center; }
        #last-updated-date { font-size: 0.8em; color: #ffffff; margin-top: 5px; margin-bottom: 20px; text-align: center; } /* Changed color to white */
        #back-to-overview-btn { display: none; } /* Allow JS to control visibility */
        #dashboard-link { border-radius: 5px; margin-bottom: 20px; }
        #search-input { background-color: #e9ecef !important; color: #212529; border: 1px solid #e9ecef; } /* Light gray for search input */
        .input-group-text { background-color: #e9ecef !important; }
        #search-input::placeholder { color: #6c757d; } /* Darker placeholder color */
        #sidebar .list-group-item { background-color: #2c3e50 !important; color: #ecf0f1; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 0; } /* List item background matches sidebar, with separator */
        #sidebar .list-group-item:last-child { border-bottom: none; } /* Remove border from last item */
        #sidebar .list-group-item a { background-color: transparent; color: #ecf0f1; text-decoration: none; display: flex; align-items: center; padding: 12px 15px; border-radius: 5px; margin: 0 10px; } /* Link background transparent, use flex for icon alignment */
        #sidebar .list-group-item a:hover, #sidebar .list-group-item a.active { background-color: #34495e; color: #ffffff; } /* Darker blue-gray for active/hover state */
        #content-area { flex-grow: 1; padding: 30px; overflow-y: auto; background-color: #ffffff; }
        .summary h1 { color: #2c3e50; margin-top: 0; text-align: center; margin-bottom: 60px; }
        .summary h2 { color: #34495e; border-bottom: 2px solid #eceff1; padding-bottom: 10px; margin-top: 60px; margin-bottom: 30px; }
        
        #overview-screen { padding: 30px; text-align: center; background-color: #ffffff; display: flex; flex-direction: column; align-items: center; }
        #overview-screen h1 { color: #2c3e50; font-size: 3em; margin-bottom: 15px; }
        #overview-screen p { color: #555; font-size: 1.2em; line-height: 1.6; max-width: 700px; margin-bottom: 40px; }
        
        .financial-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 45px; width: 100%; max-width: 1000px; margin: 0 auto; }
        .overview-metrics-grid-top { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; width: 100%; max-width: 300px; } /* Ajuste para o card de Total de Ações */
        .financial-card { background-color: #fff; border: 1px solid #4a90e2; border-radius: 12px; padding: 25px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); transition: transform 0.2s ease-in-out; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .financial-card:hover { transform: translateY(-5px); }
        .financial-card .icon { font-size: 2.5em; color: #4a90e2; margin-bottom: 10px; }
        .financial-card .label { font-size: 0.9em; font-weight: 700; color: #6c757d; text-transform: uppercase; display: block; margin-bottom: 8px; text-align: center; }
        .financial-card .value { font-size: 1.8em; font-weight: 600; color: #2c3e50; text-align: center; }
        .business-summary { background-color: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .business-summary p { color: #34495e; line-height: 1.6; }
    </style>
</head>
<body>
    <div id="sidebar" class="d-flex flex-column p-3 text-white">
        <p id="last-updated-date" class="text-end mb-4"><i class="bi bi-calendar me-2"></i></p>
        <a id="dashboard-link" class="d-block text-center fw-bold text-uppercase text-light py-3 fs-5"><i class="bi bi-house-door me-2"></i>Dashboard</a>
        <h2 class="text-center mt-4 mb-3">Ações</h2>
        <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" id="search-input" class="form-control" placeholder="Buscar Ação...">
        </div>

        <ul id="item-list" class="list-group list-group-flush"></ul>
    </div>
    <div id="content-area">
        <div id="overview-screen">
            <h1>Dashboard de Análise de Ações</h1>
            <p>Visão geral do mercado de ações.</p>
            <div class="overview-metrics-grid-top financial-info-grid">
                <div class="financial-card">
                    <i class="bi bi-bar-chart-line icon"></i>
                    <span class="label">Total de Ações</span>
                    <span class="value" id="total-acoes"></span>
                </div>
            </div>
            <div class="overview-metrics-grid financial-info-grid">
                <div class="financial-card">
                    <i class="bi bi-cash-stack icon"></i>
                    <span class="label">Média Capitalização de Mercado</span>
                    <span class="value" id="avg-market-cap"></span>
                </div>
                <div class="financial-card">
                    <i class="bi bi-graph-up-arrow icon"></i>
                    <span class="label">Maior P/L</span>
                    <span class="value" id="highest-pe"></span>
                </div>
                <div class="financial-card">
                    <i class="bi bi-graph-down-arrow icon"></i>
                    <span class="label">Menor P/L</span>
                    <span class="value" id="lowest-pe"></span>
                </div>
                <div class="financial-card">
                    <i class="bi bi-percent icon"></i>
                    <span class="label">Maior Dividend Yield</span>
                    <span class="value" id="highest-dividend-yield"></span>
                </div>
            </div>
            <p class="mt-4">Selecione uma ação na barra lateral para ver seus dados financeiros e histórico de preços detalhados.</p>
        </div>
        <div id="details-screen" style="display: none;">
            <!-- Conteúdo detalhado da Ação será gerado aqui -->
        </div>
    </div>

    <script>
            let acaoData = {};
            let allAcaoCodes = [];
            let historicoChart = null;

            // Função para carregar os dados do JSON
            async function loadAcaoData() {
                try {
                    const response = await fetch('db/dados_acoes.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Erro ao carregar dados_acoes.json:', error);
                    return {};
                }
            }

    </script>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const itemList = document.getElementById('item-list');
            const searchInput = document.getElementById('search-input');
            const overviewScreen = document.getElementById('overview-screen');
            const detailsScreen = document.getElementById('details-screen');
            const dashboardLink = document.getElementById('dashboard-link');
            let acaoData = await loadAcaoData(); // Carrega os dados de forma assíncrona
            let allAcaoCodes = [];
            let historicoChart = null;

            const formatValue = (value, type = 'default') => {
                if (value === null || typeof value === 'undefined') return 'N/A';
                if (type === 'currency') return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' }); // Usar USD como padrão ou inferir
                if (type === 'number') return value.toLocaleString('en-US');
                if (type === 'percent') return `${(value * 100).toFixed(2)}%`;
                return value;
            };



            const lastUpdatedElement = document.getElementById('last-updated-date');
            if (acaoData.last_updated && lastUpdatedElement) {
                const date = new Date(acaoData.last_updated);
                const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                lastUpdatedElement.textContent = `Atualizado em: ${date.toLocaleDateString('pt-BR', options)}`;
                delete acaoData.last_updated;
            }

            allAcaoCodes = Object.keys(acaoData).sort();
            initializeDashboard();

            function initializeDashboard() {
                if (allAcaoCodes.length === 0) {
                    overviewScreen.innerHTML = '<h1>Nenhuma Ação para exibir</h1><p>Execute o script de análise para gerar os dados.</p>';
                    return;
                }
                renderList(allAcaoCodes);
                showOverviewScreen();

                // --- Novo código para calcular e exibir métricas gerais ---
                const totalAcoes = allAcaoCodes.length;
                let totalMarketCap = 0;
                let highestPE = { value: -Infinity, code: '' };
                let lowestPE = { value: Infinity, code: '' };
                let highestDividendYield = { value: -Infinity, code: '' };

                allAcaoCodes.forEach(code => {
                    const data = acaoData[code];
                    if (data && data.info) {
                        if (data.info.marketCap) {
                            totalMarketCap += data.info.marketCap;
                        }
                        if (data.info.trailingPE && data.info.trailingPE !== null && data.info.trailingPE !== 'N/A') {
                            if (data.info.trailingPE > highestPE.value) {
                                highestPE.value = data.info.trailingPE;
                                highestPE.code = code;
                            }
                            if (data.info.trailingPE < lowestPE.value) {
                                lowestPE.value = data.info.trailingPE;
                                lowestPE.code = code;
                            }
                        }
                        if (data.info.dividendYield && data.info.dividendYield !== null && data.info.dividendYield !== 'N/A') {
                            if (data.info.dividendYield > highestDividendYield.value) {
                                highestDividendYield.value = data.info.dividendYield;
                                highestDividendYield.code = code;
                            }
                        }
                    }
                });

                const avgMarketCap = totalAcoes > 0 ? totalMarketCap / totalAcoes : 0;

                document.getElementById('total-acoes').textContent = totalAcoes;
                document.getElementById('avg-market-cap').textContent = formatValue(avgMarketCap, 'currency');
                document.getElementById('highest-pe').textContent = highestPE.code ? `${highestPE.code} (${formatValue(highestPE.value, 'number')})` : 'N/A';
                document.getElementById('lowest-pe').textContent = lowestPE.code ? `${lowestPE.code} (${formatValue(lowestPE.value, 'number')})` : 'N/A';
                document.getElementById('highest-dividend-yield').textContent = highestDividendYield.code ? `${highestDividendYield.code} (${formatValue(highestDividendYield.value, 'percent')})` : 'N/A';
                // --- Fim do novo código ---

                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const filteredCodes = allAcaoCodes.filter(code => code.toLowerCase().includes(searchTerm));
                    renderList(filteredCodes);
                });

                dashboardLink.addEventListener('click', showOverviewScreen);
            }

            function renderList(codesToRender) {
                itemList.innerHTML = codesToRender.map(code => `<li class="list-group-item"><a class="list-group-item-action text-white" data-acao="${code}"><i class="bi bi-graph-up me-2"></i>${code}</a></li>`).join('');
                itemList.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function() {
                        const acaoCode = this.getAttribute('data-acao');
                        document.querySelectorAll('#item-list a.active').forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                        renderAcaoDetails(acaoCode);
                    });
                });
            }

            function renderAcaoDetails(acaoCode) {
                const data = acaoData[acaoCode];
                if (!data || !data.info) { 
                    detailsScreen.innerHTML = `<h1>Dados não encontrados para ${acaoCode}</h1>`;
                    return;
                }

                const info = data.info;



                const iconMap = {
                    'Setor': 'bi-building',
                    'Indústria': 'bi-gear',
                    'Capitalização de Mercado': 'bi-cash-stack',
                    'P/L (Trailing)': 'bi-graph-up-arrow',
                    'P/L (Forward)': 'bi-graph-up-arrow',
                    'Preço/Vendas (TTM)': 'bi-currency-dollar',
                    'Máx. 52 Semanas': 'bi-arrow-up-right',
                    'Mín. 52 Semanas': 'bi-arrow-down-left',
                    'Dividend Yield': 'bi-percent'
                };

                const financialCards = [
                    { label: 'Setor', value: info.sector },
                    { label: 'Indústria', value: info.industry },
                    { label: 'Capitalização de Mercado', value: formatValue(info.marketCap, 'currency') },
                    { label: 'P/L (Trailing)', value: formatValue(info.trailingPE, 'number') },
                    { label: 'P/L (Forward)', value: formatValue(info.forwardPE, 'number') },
                    { label: 'Preço/Vendas (TTM)', value: formatValue(info.priceToSalesTrailing12Months, 'number') },
                    { label: 'Máx. 52 Semanas', value: formatValue(info.fiftyTwoWeekHigh, 'currency') },
                    { label: 'Mín. 52 Semanas', value: formatValue(info.fiftyTwoWeekLow, 'currency') },
                    { label: 'Dividend Yield', value: formatValue(info.dividendYield, 'percent') }
                ];

                const cardsHTML = financialCards.map(card => `
                    <div class="financial-card">
                        <i class="bi ${iconMap[card.label] || 'bi-info-circle'} icon"></i>
                        <span class="label">${card.label}</span>
                        <span class="value">${card.value}</span>
                    </div>
                `).join('');

                detailsScreen.innerHTML = `
                    <div class="summary">
                        <h1><a href="${info.website}" target="_blank" style="text-decoration: none; color: inherit;">${info.longName || acaoCode} (${acaoCode}) <i class="bi bi-box-arrow-up-right fs-5"></i></a></h1>
                        
                        <h2>Dados Financeiros</h2>
                        <div class="financial-info-grid">${cardsHTML}</div>

                        <h2>Histórico de Preços (1 Ano)</h2>
                        <div class="chart-container" style="position: relative; height: 50vh; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                            <canvas id="historicoChart"></canvas>
                        </div>

                        <h2>Resumo do Negócio</h2>
                        <div class="business-summary">
                            <p>${info.longBusinessSummary || 'Resumo não disponível.'}</p>
                        </div>
                    </div>`;
                
                renderHistoricoChart(data.historico);
                
                overviewScreen.style.display = 'none';
                detailsScreen.style.display = 'block';
                dashboardLink.style.display = 'block';
                dashboardLink.classList.remove('active');
            }

            function renderHistoricoChart(historicoData) {
                if (historicoChart) {
                    historicoChart.destroy();
                }

                const ctx = document.getElementById('historicoChart').getContext('2d');
                
                historicoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Preço de Fechamento',
                            data: historicoData.map(item => ({ x: new Date(item.Date), y: item.Close })),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            fill: 'start',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month'
                                },
                                title: {
                                    display: true,
                                    text: 'Data'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Preço de Fechamento (USD)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            }

            function showOverviewScreen() {
                overviewScreen.style.display = 'flex';
                detailsScreen.style.display = 'none';
                dashboardLink.style.display = 'block';
                document.querySelectorAll('#item-list a.active').forEach(link => link.classList.remove('active'));
                dashboardLink.classList.add('active');
            }

            initializeDashboard();
        });
    </script>
</body>
</html>

